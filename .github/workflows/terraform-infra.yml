name: Terraform Azure Infra

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      action:
        description: "Choose action: apply or destroy"
        required: true
        default: apply
        type: choice
        options:
          - apply
          - destroy

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      # ðŸ”‘ BACKEND AUTH
      ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
      ARM_TENANT_ID:       ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      ARM_CLIENT_ID:       ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
      ARM_CLIENT_SECRET:   ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

      # ðŸ”‘ PROVIDER AUTH
      TF_VAR_subscription_id: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
      TF_VAR_tenant_id:       ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      TF_VAR_client_id:       ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
      TF_VAR_client_secret:   ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

    steps:
    - uses: actions/checkout@v4

    - uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.6

    - name: Terraform Init
      run: terraform init
      working-directory: environment/dev

    - name: Terraform Plan
      if: github.event.inputs.action != 'destroy'
      run: terraform plan
      working-directory: environment/dev

    # - name: Terraform Apply
    #   if: github.event.inputs.action != 'destroy'
    #   run: terraform apply -auto-approve
    #   working-directory: environment/dev

    - name: Terraform Destroy
      if: github.event.inputs.action == 'destroy'
      run: terraform destroy -auto-approve
      working-directory: environment/dev
